# -*- mode: ruby -*-
# vi: set ft=ruby :

CORE_IP = "192.168.56.10"
GNB_IP_CORE = "192.168.56.11"
GNB_IP_UE = "192.168.57.11"

UE_IP = "192.168.57.12"
UE_EAP_IP = "192.168.58.100"
UE_LAN = "192.168.60.1"

NAUN3 = "192.168.60.100"
AUTH_SERVER_IP = "192.168.58.1"

UE_IMSI = "999700000000001"
UE_KEY = "465B5CE8B199B49FAA5F0A2EE238A6BC"
UE_OPC = "E8ED289DEBA952E4283B54E88E6183CA"

PDU_SESSIONS = "3"

#### CORE INSTALL ####

$core_install = <<-'SCRIPT'

sudo add-apt-repository ppa:open5gs/latest
sudo apt-get install -y gnupg curl
sudo snap install yq

echo -e "\nAdding MongoDB repos"
curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor

echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list

echo -e "\nAdding Node repos"
curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg

NODE_MAJOR=20
echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" | sudo tee /etc/apt/sources.list.d/nodesource.list

sudo apt-get update

echo -e "\nInstalling MongoDB, Nginx and Open5GS"
sudo apt-get install -y mongodb-org open5gs nodejs nginx

echo -e "\nReload MongoDB"
sudo systemctl start mongod
sudo systemctl enable mongod

echo -e "\nUpdate AMF NGAP and UPF GTPU IPs"
cat /etc/open5gs/amf.yaml | yq '.amf.ngap.server[0].address = "CORE_IP"' | sudo tee /etc/open5gs/amf.yaml
cat /etc/open5gs/upf.yaml | yq '.upf.gtpu.server[0].address = "CORE_IP"' | sudo tee /etc/open5gs/upf.yaml

# TESTING - So far it is not creating the interfaces
echo -e "\nEnabling support for multiple Sessions in the SMF and UPF"

sudo ip link delete ogstun

UL=$(("PDU_SESSIONS"))
for ((i=0;i<$UL;i++)); do
  OCT=$((45+$i))
  
  sudo ip tuntap add dev intun$i mode tun
  sudo ip link set intun$i up
  sudo ip addr add 10.$OCT.0.1/16 brd 10.$OCT.255.255 dev intun$i

  cat /etc/open5gs/smf.yaml \
  | yq '.smf.session['$i'].subnet = "10.'$OCT'.0.0/16"' \
  | yq '.smf.session['$i'].gateway = "10.'$OCT'.0.1"' \
  | yq '.smf.session['$i'].dnn = "internet'$i'"' \
  | sudo tee /etc/open5gs/smf.yaml
  
  cat /etc/open5gs/upf.yaml \
  | yq '.upf.session['$i'].subnet = "10.'$OCT'.0.0/16"' \
  | yq '.upf.session['$i'].gateway = "10.'$OCT'.0.1"' \
  | yq '.upf.session['$i'].dnn = "internet'$i'"' \
  | yq '.upf.session['$i'].dev = "intun'$i'"' \
  | sudo tee /etc/open5gs/upf.yaml
done

sudo systemctl restart open5gs-upfd
sudo systemctl restart open5gs-smfd 
sudo systemctl restart open5gs-amfd

echo -e "\nInstalling WebUI"
curl -fsSL https://open5gs.org/open5gs/assets/webui/install | sudo -E bash -

echo -e "\nExposing WebUI through a reverse proxy"
echo "server {
    listen 8080;

    location / {
        proxy_pass http://127.0.0.1:9999;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}" | sudo tee /etc/nginx/sites-available/webui

sudo ln -s /etc/nginx/sites-available/webui /etc/nginx/sites-enabled/
sudo systemctl restart nginx

echo -e "\nPre-loading UE in the AMF"
sudo chmod +x open5gs-dbctl
./open5gs-dbctl add "UE_IMSI" "UE_KEY" "UE_OPC"

echo -e "\nPre-loading UE APN sessions"
UL=$(("PDU_SESSIONS"))
for ((i=0;i<$UL;i++)); do
  ./open5gs-dbctl update_apn "UE_IMSI" internet$i 0
done

SCRIPT
$core_install.gsub!("CORE_IP", CORE_IP).gsub!("UE_IMSI", UE_IMSI).gsub!("UE_KEY", UE_KEY).gsub!("UE_OPC", UE_OPC).gsub!("PDU_SESSIONS", PDU_SESSIONS)

#### CORE INSTALL ####

#### UERANSIM INSTALL ####

$ueransim_install = <<-'SCRIPT'

sudo apt update

sudo apt install -y make git gcc g++ libsctp-dev lksctp-tools iproute2
sudo snap install cmake --classic
sudo snap install yq

echo -e "\nInstalling UERANSIM"
cd ~
git clone https://github.com/aligungr/UERANSIM
cd ~/UERANSIM
make

SCRIPT

#### UERANSIM INSTALL ####

#### gNodeB CONFIG ####

$gnb_install = <<-'SCRIPT'
cd ~/UERANSIM

echo -e "\nUpdate gNodeB and Core IPs"
cat config/open5gs-gnb.yaml \
| yq '.linkIp = "GNB_IP_UE"' \
| yq '.ngapIp = "GNB_IP_CORE"' \
| yq '.gtpIp = "GNB_IP_CORE"' \
| yq '.amfConfigs[0].address = "CORE_IP"' \
| sudo tee config/open5gs-gnb.yaml

echo -e "\nRunning gNB"
build/nr-gnb -c config/open5gs-gnb.yaml &> /log/gnb_$(date +%s).log &

SCRIPT
$gnb_install.gsub!("CORE_IP", CORE_IP).gsub!("GNB_IP_CORE", GNB_IP_CORE).gsub!("GNB_IP_UE", GNB_IP_UE).gsub!("PDU_SESSIONS", PDU_SESSIONS)

#### gNodeB CONFIG ####

#### UE CONFIG ####

$ue_install = <<-'SCRIPT'
cd ~/UERANSIM

echo -e "\nUpdate gNodeB IP"
cat config/open5gs-ue.yaml | yq '.gnbSearchList[0] = "GNB_IP_UE"' | sudo tee config/open5gs-ue.yaml

echo -e "\nEnabling multiple PDU via different APNs in a single Slice"
UL=$(("PDU_SESSIONS"))
for ((i=0;i<$UL;i++)); do
  cat config/open5gs-ue.yaml \
  | yq '.sessions['$i'].type = "IPv4"' \
  | yq '.sessions['$i'].type style="single"' \
  | yq '.sessions['$i'].apn = "internet'$i'"' \
  | yq '.sessions['$i'].apn style="single"' \
  | yq '.sessions['$i'].slice.sst = 1' \
  | sudo tee config/open5gs-ue.yaml
done

echo -e "\nEnabling IP forwarding"
sudo sysctl -w net.ipv4.ip_forward=1

echo -e "\nRunning UE"
build/nr-ue -c config/open5gs-ue.yaml &> /log/ue_$(date +%s).log &

SCRIPT
$ue_install.gsub!("GNB_IP_UE", GNB_IP_UE).gsub!("PDU_SESSIONS", PDU_SESSIONS)

#### UE CONFIG ####

#### EAP AUTH SERVER CONFIG ####

$auth_server_install = <<-'SCRIPT'

sudo apt update

sudo apt install -y freeradius

SCRIPT

#### EAP AUTH SERVER CONFIG ####

Vagrant.configure("2") do |config|
  
  config.vm.define "core" do |core|
    core.vm.box = "ubuntu/jammy64"

    # Open5GS 5GC needs at least 2GB of RAM
    core.vm.provider "virtualbox" do |v|
      v.memory = 2048
      v.cpus = 1
    end

    core.vm.hostname = "core"
    core.vm.network "private_network", ip: CORE_IP

    config.vm.provision "file", source: "open5gs-dbctl", destination: "open5gs-dbctl"

    core.vm.provision "shell", inline: $core_install

    # Exposing WebUI
    core.vm.network "forwarded_port", guest: 8080, host: 9999
  end

  config.vm.define "gnb" do |gnb|
    gnb.vm.box = "ubuntu/jammy64"

    gnb.vm.provider "virtualbox" do |v|
      v.memory = 1024
      v.cpus = 1
    end

    gnb.vm.hostname = "gnb"

    # gNB to Core
    gnb.vm.network "private_network", ip: GNB_IP_CORE
    
    # gNB to Subs
    gnb.vm.network "private_network", ip: GNB_IP_UE

    gnb.vm.synced_folder "./runtime_logs", "/log", create: true

    gnb.vm.provision "shell", inline: $ueransim_install

    gnb.vm.provision "shell", inline: $gnb_install
  end

  config.vm.define "ue" do |ue|
    ue.vm.box = "ubuntu/jammy64"

    ue.vm.provider "virtualbox" do |v|
      v.memory = 1024
      v.cpus = 1
    end

    ue.vm.hostname = "ue"
    
    # RAN interface
    ue.vm.network "private_network", ip: UE_IP

    # EAP Auth Server interface
    ue.vm.network "private_network", ip: UE_EAP_IP

    # LAN interface
    ue.vm.network "private_network", ip: UE_LAN

    ue.vm.synced_folder "./runtime_logs", "/log", create: true

    ue.vm.provision "shell", inline: $ueransim_install

    ue.vm.provision "shell", inline: $ue_install
  end

  config.vm.define "auth_server" do |auth_server|
    auth_server.vm.box = "ubuntu/jammy64"

    auth_server.vm.provider "virtualbox" do |v|
      v.memory = 1024
      v.cpus = 1
    end

    auth_server.vm.hostname = "authserver"
    
    # Authenticator Client interface
    auth_server.vm.network "private_network", ip: AUTH_SERVER_IP

    auth_server.vm.provision "shell", inline: $auth_server_install

    auth_server.vm.synced_folder "./runtime_logs", "/log", create: true
  end

  config.vm.define "naun3" do |naun3|
    naun3.vm.box = "ubuntu/jammy64"

    naun3.vm.provider "virtualbox" do |v|
      v.memory = 1024
      v.cpus = 1
    end

    naun3.vm.hostname = "naun3"
    naun3.vm.network "private_network", ip: NAUN3

    naun3.vm.synced_folder "./runtime_logs", "/log", create: true
  end

end
